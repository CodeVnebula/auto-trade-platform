{% extends 'base.html' %}
{% load static %}

{% block title %}Profile{% endblock %}

{% block stylesheet %}
    <link rel="stylesheet" href="{% static 'css/custom-css.css' %}">
{% endblock stylesheet%}
<body>


    {% block content %}
    <main class="main">

        {% include 'components/breadcrumb.html' %}

        <!-- user-profile -->
        <div class="user-profile py-120">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3">
                        {% include 'components/user-profile-area.html' %}
                    </div>
                    <div class="col-lg-9">
                        <div class="user-profile-wrapper">
                            <div class="row">
                                <div class="col-lg-7">
                                    <div class="user-profile-card">
                                        <h4 class="user-profile-card-title">პროფილის დეტალები</h4>
                                        <div class="user-profile-form">
                                            <form action="#">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="first-name">სახელი</label>
                                                            <input type="text" id="first-name" class="form-control" value=""
                                                                placeholder="გვარი">
                                                            <div id="error-first-name" style="color: red; display: none;"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="last-name">გვარი</label>
                                                            <input type="text" id="last-name" class="form-control" value=""
                                                                placeholder="გვარი">
                                                            <div id="error-last-name" style="color: red; display: none;"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="email">ელ.ფოსტა</label>
                                                            <input type="text" id="email" class="form-control" value="" placeholder="ელ.ფოსტა" readonly style="background-color: #e9ecef;">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="phone">ტელეფონი</label>
                                                            <input type="text" id="phone" class="form-control"
                                                                value="" placeholder="ტელეფონი">
                                                            <div id="error-phone" style="color: red; display: none;"></div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <div class="form-group">
                                                            <label for="address">მისამართი</label>
                                                            <input type="text" id="address" class="form-control"
                                                                value="" placeholder="მისამართი">
                                                        </div>
                                                    </div>
                                                </div>
                                                <button id="save-changes-btn" type="button" class="theme-btn my-3"><span class="far fa-user"></span> ცვლილებების შენახვა</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="user-profile-card">
                                        <h4 class="user-profile-card-title">პაროლის აღდგენა</h4>
                                        <div class="col-lg-12">
                                            <div class="user-profile-form">
                                                <div id="error-message" style="color: red; display: none;"></div>
                                                <div style="background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 10px; padding: 20px; text-align: center; max-width: 400px; margin: 0 auto;">
                                                    <img src="https://img.icons8.com/color/96/email.png" alt="Reset Password" style="margin-bottom: 15px;">
                                                
                                                    <p style="font-size: 14px; color: #555; margin-bottom: 20px; line-height: 1.5;">
                                                        პაროლის აღსადგენად, დააჭირეთ ქვემოთ მოცემულ ღილაკს. ჩვენ გამოგიგზავნით ბმულს ინსტრუქციებით თქვენს ელ.ფოსტაზე.
                                                    </p>
                                                
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <button type="button" onclick="sendLink()" class="theme-btn" style>
                                                            <i class="far fa-envelope" style="margin-right: 8px;"></i>ბმულის გაგზავნა 
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% comment %} <div class="col-lg-12">
                                    <div class="user-profile-card profile-store">
                                        <h4 class="user-profile-card-title">Store Info</h4>
                                        <div class="col-lg-12">
                                            <div class="user-profile-form">
                                                <form action="#">
                                                    <div class="form-group">
                                                        <div class="store-logo-preview">
                                                            <img src="assets/img/store/logo.jpg" alt="">
                                                        </div>
                                                        <input type="file" class="store-file">
                                                        <button type="button" class="theme-btn store-upload"><span class="far fa-upload"></span> Upload Logo</button>
                                                    </div>
                                                    <div class="form-group">
                                                        <div class="store-banner-preview">
                                                            <img src="assets/img/store/banner.jpg" alt="">
                                                        </div>
                                                        <input type="file" class="store-file">
                                                        <button type="button" class="theme-btn store-upload mb-4"><span class="far fa-upload"></span> Upload Banner</button>
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Store Name</label>
                                                        <input type="text" class="form-control" value="Automotive Car"
                                                            placeholder="Store Name">
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Contact Phone Number</label>
                                                        <input type="text" class="form-control" value="+2 123 654 7898"
                                                            placeholder="Contact Phone Number">
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Contact Email</label>
                                                        <input type="text" class="form-control" value="antoni@example.com"
                                                            placeholder="Contact Email">
                                                    </div>
                                                    <button type="button" class="theme-btn my-3"><span class="far fa-save"></span> Save Changes</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div> {% endcomment %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- user-profile end -->

    </main>
    {% endblock content %}

    {% block scripts %}
    <script type="module" src="{% static 'js/tokens.js' %}"></script>
    <script src="{% static 'js/auth.js' %}"></script>

    <script type="module">
        import { getProfile, handleProfileImageChange, updateProfileInfo, logout } from '{% static "js/profiles.js" %}';
        var loginUrl = "{% url 'frontend:login' %}";
        
        document.addEventListener('DOMContentLoaded', function() {
            var logoutBtn = document.getElementById('profile-logout');
        
            logoutBtn.addEventListener('click', function() {
                (async () => {
                    const response = await logout(loginUrl);
                })();
            });
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('profile-link').classList.add('active');
            
            console.log("DOMContentLoaded event fired");
            (async () => {
                const data = await getProfile(loginUrl);
                console.log("data: ", data);

                if (data.profile_picture) {
                    document.getElementById('profile-picture').src = data.profile_picture;
                } else {
                    document.getElementById('profile-picture').src = "{% static 'img/account/user.png' %}";
                }
                document.getElementById('full-name').innerText = data.user.first_name + " " + data.user.last_name;
                document.getElementById('email1').innerText = data.user.email;
                document.getElementById('chats-count').innerText = data.chats_count;

                document.getElementById('first-name').value = data.user.first_name;
                document.getElementById('last-name').value = data.user.last_name;
                document.getElementById('email').value = data.user.email;
                if (data.user.phone) 
                    document.getElementById('phone').value = data.user.phone;
                if (data.user.address) 
                    document.getElementById('address').value = data.user.address;
                
            })();
        });

        document.querySelector('.profile-img-file').addEventListener('change', function() {
            (async () => {
                const response = await handleProfileImageChange(loginUrl, this.files[0]);
                const data = await response.json();
                document.getElementById('profile-picture').src = data.profile_picture;
                console.log("Profile picture updated successfully:", data);
                
            })();
        });

        var saveChangesBtn = document.getElementById('save-changes-btn');

        saveChangesBtn.addEventListener('click', function() {
            (async () => {
                const response = await updateProfileInfo(loginUrl);
                const data = await response.json();
                console.log("Profile info updated successfully:", data);
            })();
        });
    </script>

    <script>
        function togglePasswordVisibility(inputId) {
            var inputField = document.getElementById(inputId);
            var currentType = inputField.type;
            inputField.type = currentType === "password" ? "text" : "password";
            
            var icon = document.querySelector(`#${inputId} + .toggle-password`);
            icon.classList.toggle('fa-eye-slash');
            icon.classList.toggle('fa-eye');
        }
    </script>   
    
    
    {% endblock scripts %}


</body>

</html>